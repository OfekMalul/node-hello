pipeline {
  agent {
    label 'agent1'
  }
  
  environment {
    IMAGE_NAME = 'node-hello-world'
    IMAGE_TAG = '1.0.0'
    DOCKERHUB_CREDENTIALS = credentials('ofekmalul-dockerhub')
    MINIKUBE_SERVER_CREDENTIALS = credentials('minikube-deploy-server')
    DOCKER_REPO = 'ofekmalul/leumi-home-assignment'
  }
  stages {
    stage('Build Docker Image') {
      steps {
        sh 'docker build . -t node-hello-world:1.0.0'
      }
    }

    stage('Run Image and check availability') {
      steps {
        sh '''
            docker run -p 3000:3000 -d node-hello-world:1.0.0
            wget localhost:3000
        '''
      }
    }
      stage('Push to DockerHub') {
      steps {
        sh '''
            echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
            docker tag ${IMAGE_NAME}:1.0.0 ${DOCKER_REPO}:1.0.0
            docker push ${DOCKER_REPO}:1.0.0
        '''
      }
    }
    stage('Deployment'){
        steps {
            script{
			withCredentials([sshUserPrivateKey(credentialsId:'minikube-deploy-server', keyFileVariable: 'KEY')]){
					sh '''
                    
                    ssh -o StrictHostKeyChecking=no -i ${KEY} ubuntu@54.164.82.174 "
                        kubctl get pods
                    "
                    '''
				}
			}
        }
    }
  }

    post{

	    always{
            sh '''
                docker stop $(sudo docker ps -q)
                sudo docker rm $(sudo docker ps -aq)
                docker ps -a
            '''
        }

    } 
}