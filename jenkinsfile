pipeline {
  agent {
    label 'agent1'
  }

  stages {
    stage('Build Docker Image') {
      steps {
        sh 'docker build . -t node-hello-world:1.0.0'
      }
    }

    stage('Run Image and check availability') {
      steps {
        sh '''
            docker run -p 3000:3000 -d node-hello-world:1.0.0
            wget localhost:3000
        '''
      }
    }

    stage('Push to DockerHub') {
      steps {
        script{
			withCredentials([usernamePassword(credentialsId: 'ofekmalul-dockerhub', passwordVariable: 'PSWD', usernameVariable: 'LOGIN')]){
                sh '''
                   docker tag ${IMG_NAME} ${DOCKER_REPO}:1.0.0
                   echo ${PSWD} | sudo docker login -u ${LOGIN} --password-stdin
                   docker push ${DOCKER_REPO}:1.0.0
                '''
			}
		}
      }

    }
  }

    post{

	    always{
            sh '''
                docker stop $(sudo docker ps -q)
                sudo docker rm $(sudo docker ps -aq)
                docker ps -a
            '''
        }

    } 
}